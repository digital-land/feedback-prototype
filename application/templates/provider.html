{% extends "layouts/page.html" %}

{% set includesMap = true %}
{%- block mapAssets %}
  <script src="https://unpkg.com/maplibre-gl@1.14.0-rc.1/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@1.14.0-rc.1/dist/maplibre-gl.css" rel="stylesheet"/>
  {{ super() }}
{% endblock -%}

{% block pageTitle %}Feedback{% endblock %}

{# {% block page_summary_content %}
  <div class="app-!-self-clear">
    <img src="{{ assetPath | default('/static') }}/images/open-digital-planning-logo.svg" width="100" alt="" class="app-!-float-right">
    <p>This organisation is a member of the open digital planning programme.</p>
  </div>
{% endblock page_summary_content %} #}

{% block content %}

  {#
    ############################################
    [START] stats experiment
    ############################################

    @adam - This is an idea for showing some useful metrics or snapshot of the data from
    an LPA. Not sure about this though. Might be worth a discussion about value and feasibility.

  #}

  {% macro appStat(params={}) %}
    {% if params.href %}
      <a href="{{ params.href }}" class="app-stat">
    {% else %}
      <div class="app-stat">
    {% endif %}
        <span class="app-stat__value">
          {{ params.value | default('1') }}
          {%- if params.total -%}<span class="app-stat__value__total">/{{ params.total }}</span>{%- endif -%}
        </span>
        <span class="app-stat__label">{{ params.label | default('Label text') }}</span>
    {% if params.href %}
      </a>
    {% else %}
      </div>
    {% endif %}
    <!-- /.app-stat -->
  {% endmacro %}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <div class="govuk-grid-row">

        {# links to the table below which lists all the datasets #}
        <div class="govuk-grid-column-one-quarter">
          {{
            appStat({
              'value': '10',
              'total': '14',
              'href': '#datasets',
              'label': 'Datasets'
            })
          }}
        </div>
        <!-- /.govuk-grid-column-one-quarter -->

        {# links to an aggregate list of all 'notes' for this organisation #}
        <div class="govuk-grid-column-one-quarter">
          {{
            appStat({
              'value': '7',
              'href': './notes',
              'label': 'Notes'
            })
          }}
        </div>
        <!-- /.govuk-grid-column-one-quarter -->

        {# links to an aggregate list of all source urls for this organisation #}
        <div class="govuk-grid-column-one-quarter">
          {{
            appStat({
              'value': '20',
              'href': '#sources',
              'label': 'Sources'
            })
          }}
        </div>
        <!-- /.govuk-grid-column-one-quarter -->
      </div>
      <!-- /.govuk-grid-row -->

    </div>
  </div>

  <hr class="govuk-section-break govuk-section-break--l govuk-!-margin-bottom-7 govuk-section-break--visible">

  {#
    ############################################
    [END] stats experiment
    ############################################
  #}

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

      <table class="govuk-table" id="datasets">
        <caption class="govuk-table__caption">
          <div class="govuk-heading-l govuk-!-margin-bottom-3">Datasets</div>
          <div class="govuk-body">This table shows the datasets the planning data platform will attempt to collect from {{ page_data.title | title }}.</div>
        </caption>
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header govuk-!-width-one-half">
              Dataset
            </th>
            <th scope="col" class="govuk-table__header govuk-!-width-one-quarter"">
              Notes
            </th>
            <th scope="col" class="govuk-table__header govuk-!-width-one-quarter r govuk-!-text-align-right">
              Status
            </th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">
              <a href="">Article 4 Directions</a>
            </td>
            <td class="govuk-table__cell">0 notes</td>
            <td class="govuk-table__cell govuk-!-text-align-right">
              {{ govukTag({
                'text': 'collecting',
                'classes': 'govuk-tag--blue'
              }) }}
            </td>
          </tr>
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">
              <a href="">Article 4 Direction Areas</a>
            </td>
            <td class="govuk-table__cell">5 notes</td>
            <td class="govuk-table__cell govuk-!-text-align-right">
              {{ govukTag({
                'text': 'collecting',
                'classes': 'govuk-tag--blue'
              }) }}
            </td>
          </tr>
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">
              <a href="">Conservation Areas</a>
            </td>
            <td class="govuk-table__cell">2 notes</td>
            <td class="govuk-table__cell govuk-!-text-align-right">
              {{ govukTag({
                'text': 'collecting',
                'classes': 'govuk-tag--blue'
              }) }}
            </td>
          </tr>
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">
              <a href="">Conservation Area geometries</a>
            </td>
            <td class="govuk-table__cell">0 notes</td>
            <td class="govuk-table__cell govuk-!-text-align-right">
              {{ govukTag({
                'text': 'Not found'
              }) }}
            </td>
          </tr>
          {# ... all other datasets to be outputted... #}

        </tbody>
      </table>

      {% set tableDetails  %}
      <p>This table shows each dataset The Department for Levelling Up attempts to collect data for from {{ page_data.title | title }}.</p>
      <p><strong>Notes</strong> - The number of notes about this dataset and the data being collected.</p>
      <p><strong>Status</strong> - If planning.data.govuk is actively collecting or is unable to find and collect data.</p>
      {% endset %}

      {{
        govukDetails({
          'summaryText': 'Help understanding this table',
          'html': tableDetails
        })
      }}

    </div>
  </div>

  <hr class="govuk-section-break govuk-!-margin-bottom-6 govuk-section-break--visibles">

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-l govuk-!-margin-bottom-3">View this data</h2>
      <p id="aria-label-national-map" class="govuk-body">
        Data collected from {{ page_data.title | title }} by planning.data.gov.uk can be explored on the following map.
      </p>
    </div>
    <div class="govuk-grid-column-full">

      {% set mapHTML %}
        <div class="dl-map__wrapper govuk-!-margin-bottom-6" style="min-height: 700px;">

          <div class="zoom-controls" data-module="zoom-controls">
            <button class="zoom-controls__btn" data-zoom-control="in">
              <span class="govuk-visually-hidden">Zoom in</span>
              <span>+</span>
            </button>
            <span class="zoom-controls__count-container" aria-live="polite">
              <span class="govuk-visually-hidden">The map is at zoom level </span>
              <span class="zoom-controls__count">6</span>
            </span>
            <button class="zoom-controls__btn" data-zoom-control="out">
              <span class="govuk-visually-hidden">Zoom out</span>
              <span>-</span>
            </button>
          </div>

          {% macro layerControlItem(layer) %}
            <li class="dl-map__layer-item govuk-!-margin-bottom-2" data-layer-control="{{ layer.dataset }}"
            {% if layer.paint_options.type %}data-layer-data-type={{layer.paint_options.type}}{% endif %} data-style-options="{% if layer.paint_options %}{{ layer.paint_options.colour }},{{ layer.paint_options.opacity }}{% endif %}">
              <div class="govuk-checkboxes__item">
                <input class="govuk-checkboxes__input" id="{{ layer.dataset }}" name="{{ layer.dataset }}" type="checkbox" value="{{ layer.dataset }}" {{ "checked='checked'" if layer.checked }}>
                <label class="govuk-label govuk-checkboxes__label" for="{{ layer.dataset }}">
                  <span class="dl-label__key">
                    <span class="dl-label__key__symbol{{ ' dl-label__key__symbol--circle' if layer.paint_options.type and layer.paint_options.type == 'point' }}"
                style="border-color: {{layer.paint_options.colour|default('#003078')}}; background: rgba({{layer.paint_options.colour|default('#003078')|hex_to_rgb}},{{ layer.paint_options.opacity|default('0.5') }});"></span>
                    {{ layer.name }}
                  </span>
                </label>
              </div>
            </li>
          {% endmacro %}

          <div id="mapid" class="dl-map" aria-labelledby="aria-label-national-map"></div>

          <div class="dl-map__side-panel dl-map__side-panel--full js-hidden" tabindex="-1" role="dialog" aria-hidden="false" open="true" aria-modal="true">
            <div class="dl-map__side-panel__heading">
              <h3 class="govuk-heading-s govuk-!-margin-bottom-0">Data layers</h3>
            </div>
            <div class="dl-map__side-panel__content">
              <div class="govuk-checkboxes" data-module="filter-checkboxes">
                <div class="dl-filter-group__auto-filter">
                  <label for="input-71108" class="govuk-label govuk-visually-hidden">
                    Filter Show only
                  </label>
                  <input id="input-71108" class="govuk-input dl-filter-group__auto-filter__input" type="text" aria-describedby="checkbox-filter-71108" aria-controls="checkboxes-71108">
                </div>
                <ul class="govuk-list govuk-!-margin-bottom-0" data-module="layer-controls" role="group">
                  <span id="checkbox-filter-71108" class="dl-filter-group__auto-filter__desc govuk-visually-hidden" aria-live="polite" data-single="option found" data-multiple="options found" data-selected="selected">{{ layers|length }} options found, 0 selected</span>
                  <span class="app-filter-group__status-update js-hidden govuk-!-padding-bottom-3 dl-secondary-text" aria-live="polite" data-single="dataset" data-multiple="datasets">0 datasets hidden</span>
                  {% for layer in layers %}
                    {{ layerControlItem(layer) }}
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>
      {% endset %}

      {{ mapHTML }}

      <p>Have you found a problem with this data? You can <a href="#">Report a data problem</a> for us to respond to.</p>

    </div>
  </div>
  <!-- /.govuk-grid-row -->

  <hr class="govuk-section-break govuk-section-break--m govuk-!-margin-bottom-0 govuk-section-break--visibl">

  {# <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-l govuk-!-margin-bottom-3">Help to publish planning data</h2>
    </div>
    <div class="govuk-grid-column-full">

    </div>
  </div>
  <!-- /.govuk-grid-row --> #}

{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  <script src="/static/javascripts/dl-national-map-controller.js"></script>
  <script src="/static/javascripts/filter-checkbox-extension.js"></script>
  <script>
    // grab html elements
    const $controlsList = document.querySelector('[data-module="layer-controls"]')
    const $zoomMod = document.querySelector('[data-module="zoom-controls"]')
    // init national map
    const mapController = new MapController($controlsList, $zoomMod).init({
      baseTileStyleFilePath: "/static/javascripts/base-tile.json",
      vectorSource: "https://datasette-tiles.planning.data.gov.uk/-/tiles/dataset_tiles/{z}/{x}/{y}.vector.pbf",
      LayerControlOptions: {
        layerURLParamName: "dataset",
      }
    })

    // extend the filter checkbox component to work with the map
    const $fgStatusUpdate = $controlsList.querySelector('.app-filter-group__status-update')
    extendFilterCheckboxes($fgStatusUpdate)

    var $filterCheckboxes = document.querySelectorAll('[data-module="filter-checkboxes"]')
    $filterCheckboxes.forEach(el => {
      new window
        .DLFrontend
        .FilterCheckboxes(el)
        .init()
    })
  </script>
{% endblock %}
